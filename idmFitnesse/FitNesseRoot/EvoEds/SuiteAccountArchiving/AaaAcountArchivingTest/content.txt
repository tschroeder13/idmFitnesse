!***> local setup
!define REMOTE_DEBUG_COMMAND {java -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8001 -cp %p %m}

!define one_year_ago {!monthsFromToday (yyyyMMddHHmmss) -12}
!define ten_days_ago {!weekDaysFromToday (yyyyMMddHHmmss) -10}
!define active_resource { cn=1626,cn=ResourceDefs,cn=RoleConfig,cn=AppConfig,cn=UserApplication,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#1#<assignment><start_tm>20140318145605Z</start_tm><req_tm>20140318145605Z</req_tm><inst-guid>80607ef632694609b1b1031efe2d44f4</inst-guid><req>cn=GA1633,ou=Services,ou=Applications,o=base,c=DE</req><req_desc>Request generated by policyDriver DN: \IDMTEST\DE\SYSTEM\IDM\DriverSet1\GMS_EDS-TEST
Location: vnd.nds.stream://IDMTEST/DE/SYSTEM/IDM/DriverSet1/GMS_EDS-TEST/Publisher/pub-ctp-HandleMemberships#XmlData:220</req_desc><ent-ref><?xml version="1.0" encoding="UTF-8"?><ref>
<src>UA</src>
<id/>
<param>G91Lq9PXkEgSoRvdS6vT1w==</param>
</ref>
</ent-ref><ent-dn>C=DE\O=SYSTEM\OU=IDM\CN=DriverSet1\CN=EDS_GroupEntitlement\CN=EDSGroups</ent-dn><cause><type>user</type></cause></assignment> }
!define inactive_resource { cn=1626,cn=ResourceDefs,cn=RoleConfig,cn=AppConfig,cn=UserApplication,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#0#<assignment><start_tm>20140318145605Z</start_tm><req_tm>20140318145605Z</req_tm><inst-guid>80607ef632694609b1b1031efe2d44f4</inst-guid><req>cn=GA1633,ou=Services,ou=Applications,o=base,c=DE</req><req_desc>Request generated by policyDriver DN: \IDMTEST\DE\SYSTEM\IDM\DriverSet1\GMS_EDS-TEST
Location: vnd.nds.stream://IDMTEST/DE/SYSTEM/IDM/DriverSet1/GMS_EDS-TEST/Publisher/pub-ctp-HandleMemberships#XmlData:220</req_desc><ent-ref><?xml version="1.0" encoding="UTF-8"?><ref>
<src>UA</src>
<id/>
<param>G91Lq9PXkEgSoRvdS6vT1w==</param>
</ref>
</ent-ref><ent-dn>C=DE\O=SYSTEM\OU=IDM\CN=DriverSet1\CN=EDS_GroupEntitlement\CN=EDSGroups</ent-dn><cause><type>user</type></cause></assignment> }
!define active_idm_c { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#1#Group|C|853 }
!define active_idm_l { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#1#Group|L|330 }
!define active_idm_ou { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#1#Group|OU|10205 }
!define inactive_idm_c { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#0#Group|C|853 }
!define inactive_idm_l { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#0#Group|L|330 }
!define inactive_idm_ou { cn=MASTERDB_EDS-TEST,cn=DriverSet1,ou=IDM,o=SYSTEM,c=DE#0#Group|OU|10205 }
*!
Es sollen zeitnah beide Prozessschritte für den User ${dn} getestet werden.

!1 User anlegen
|script:Ldap Operations|${meta}                                                                                                |
|create Object         |${dn}               |With Attributes             |${attributes}     |And Objectclasses|${objectclasses}|
|ensure                |object              |${dn}                       |exists                                               |
|set Attribute         |degDeletedTimestamp |Value                       |${one_year_ago}Z  |on Object        |${dn}           |
|add attribute         |degEntitlementRef   |with value                  |${active_idm_c}   |To Object        |${dn}           |
|add attribute         |degEntitlementRef   |with value                  |${active_idm_l}   |To Object        |${dn}           |
|add attribute         |degEntitlementRef   |with value                  |${active_idm_ou}  |To Object        |${dn}           |
|add attribute         |nrfAssignedResources|with value                  |${active_resource}|To Object        |${dn}           |
|add attribute         |groupMembership     |with value                  |${test_group}     |To Object        |${dn}           |
|add attribute         |securityEquals      |with value                  |${test_group}     |To Object        |${dn}           |
|add attribute         |member              |with value                  |${dn}             |To Object        |${test_group}   |
|add attribute         |equivalentToMe      |with value                  |${dn}             |To Object        |${test_group}   |
|reject                |attribute           |degArchivingProcessStartTime|Exists For Object |${dn}                             |

!!!|Sleep|30000|

!1 Trigger auslösen
|script:Ssh Nds Job Operation|${meta_adm_user}|${meta_adm_pwd}|${meta}|
|start job                   |${meta_trg_job}                         |

|Sleep|60000|

!1 Ersten Lauf verifizieren
|script:Ldap Operations|${meta}                                                                                       |
|ensure                |attribute|degArchivingProcessStartTime|Exists For Object|${dn}                                |
|ensure                |attribute|nrfAssignedResources        |contains value   |${inactive_resource}|For Object|${dn}|
|ensure                |attribute|degEntitlementRef           |contains value   |${inactive_idm_c}   |For Object|${dn}|
|ensure                |attribute|degEntitlementRef           |contains value   |${inactive_idm_l}   |For Object|${dn}|
|ensure                |attribute|degEntitlementRef           |contains value   |${inactive_idm_ou}  |For Object|${dn}|

!1 degArchivingProcessStartTime umsetzen
|script:Ldap Operations|${meta}                                                                                                     |
|set Attribute         |degArchivingProcessStartTime|Value                       |${ten_days_ago}Z|on Object       |${dn}           |
|ensure                |attribute                   |degArchivingProcessStartTime|contains value  |${ten_days_ago}Z|for Object|${dn}|

!1 Trigger erneut auslösen
|script:Ssh Nds Job Operation|${meta_adm_user}|${meta_adm_pwd}|${meta}|
|start job                   |${meta_trg_job}                         |

!1 Zweiten Lauf verifizieren
|script:Ldap Operations|${meta}                                                      |
|ensure                |attribute|jobcode    |exists for object|${dn}                |
|ensure                |attribute|jobcode    |contains value   |move|for object|${dn}|
|ensure                |attribute|degInactive|contains value   |true|for object|${dn}|

|Sleep|300000|

!include -seamless DeleteResources
